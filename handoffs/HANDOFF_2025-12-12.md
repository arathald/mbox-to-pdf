# Handoff: mbox-to-pdf Implementation

**Date**: 2025-12-12
**From**: Claude (Opus 4.5)
**Status**: Core API complete, PDF generation blocked on WeasyPrint native deps

---

## Project Overview

**mbox-to-pdf** is a privacy-first desktop application for converting Gmail Takeout MBOX email exports to professionally formatted PDF documents.

- **Repository**: `/Users/greg/Code/mbox-to-pdf`
- **License**: MIT (open source, designed for easy privacy auditing)
- **Primary Use Cases**: Legal document discovery, financial records retention, forensic analysis
- **Architecture**: API-first design (business logic testable without GUI)

---

## Implementation Status

### Completed This Session

| Function | Description | Tests |
|----------|-------------|-------|
| `parse_mbox(path)` | Parse mbox file → List[Email] | 8 |
| `merge_and_deduplicate([paths])` | Merge multiple files, dedupe by Message-ID | 14 |
| `group_emails_by_date(emails, strategy)` | Group by month/quarter/year | 10 |
| `render_attachment(attachment)` | Text/CSV/image → HTML | 10 |
| `render_email_to_html(email)` | Complete email → HTML with headers | 13 |
| `generate_pdf(html, path)` | HTML → PDF via WeasyPrint | 6 (skip) |

**Total**: 68 tests (62 passing, 6 skipped due to WeasyPrint native deps)

### Dataclasses Implemented

**Email**:
- `message_id`, `from_addr`, `to_addr`, `date`, `subject`
- `body_text`, `body_html`
- `cc_addr`, `bcc_addr`, `in_reply_to`, `references`
- `attachments`, `headers`, `x_mailer`

**Attachment**:
- `filename`, `mime_type`, `size_bytes`, `raw_content`
- `rendered_content`, `content_type`, `error`

---

## Current Blocker: WeasyPrint Native Dependencies

WeasyPrint requires native libraries (pango, glib/gobject) that are installed via Homebrew but not being found by Python:

```
OSError: cannot load library 'libgobject-2.0-0'
```

**Attempted**:
- `brew install pango` - Installed successfully
- `brew install glib` - Already installed
- `DYLD_LIBRARY_PATH` - Did not help

**Root Cause**: The system Python (3.9 from Xcode at `/Applications/Xcode.app/`) isn't finding Homebrew libraries at `/opt/homebrew/lib`.

**Potential Solutions**:
1. Use Homebrew Python instead of system Python
2. Create a venv with Homebrew Python
3. Symlink libraries or set proper paths
4. Use `pkg-config` to help cffi find libraries

The tests skip gracefully when WeasyPrint can't load, so this doesn't block other development.

---

## Key Design Decisions (From Previous Sessions)

1. **Threading**: Metadata display only (In-Reply-To, References fields shown), no thread reconstruction
2. **Continuation Headers**: PDF post-processing approach (WeasyPrint doesn't support mid-flow injection)
3. **Warning UX**: Batch into collapsible panel, not modal dialog spam
4. **Multi-file Merging**: Deduplicate by Message-ID before grouping
5. **Gmail Takeout**: Emails duplicated across label folders; All Mail is canonical

---

## File Locations

### Source Code
- `/Users/greg/Code/mbox-to-pdf/src/mbox_converter.py` - Core implementation (~500 lines)

### Tests
- `/Users/greg/Code/mbox-to-pdf/tests/test_mbox_converter.py` - Test suite (68 tests)
- `/Users/greg/Code/mbox-to-pdf/tests/conftest.py` - Pytest fixtures

### Fixtures
- `/Users/greg/Code/mbox-to-pdf/sample_data/simple.mbox` - 2 plain-text emails
- `/Users/greg/Code/mbox-to-pdf/sample_data/complex.mbox` - 10 emails with attachments
- `/Users/greg/Code/mbox-to-pdf/sample_data/takeout_fixture/` - Gmail Takeout structure

### Documentation
- `/Users/greg/Code/mbox-to-pdf/DESIGN.md` - Comprehensive requirements (~1900 lines)
- `/Users/greg/Code/mbox-to-pdf/CLAUDE.md` - Project guide for AI assistants

---

## Fixture Details

### simple.mbox (2 emails)
- Email 1: Plain text, Jan 4 2008, `<simple001@example.com>`
- Email 2: Reply with In-Reply-To, Jan 5 2008, `<simple002@example.com>`

### complex.mbox (10 emails, Jan 10-19 2008)
1. Text attachment (notes.txt)
2. CSV attachment (sales_q1.csv)
3. HTML email with inline image (timeline.png)
4. Multiple attachments (README.txt, data.csv, logo.png)
5. Non-UTF8 encoding (ISO-8859-1)
6. HTML attachment (report.html)
7. Excel attachment (budget_2008.xlsx)
8. Word attachment (project_proposal.docx)
9. PDF attachment (financial_report_q1.pdf)
10. Unsupported file (meeting-recording.mp3)

### takeout_fixture
- All Mail.mbox: 21 records, 12 unique Message-IDs
- Inbox.mbox: 2 emails (dupes of simple)
- Work Projects.mbox: 10 emails (dupes of complex)
- Spam.mbox: 0 emails (empty file test)

---

## Next Steps

<instructions>

### Immediate Priority: Resolve WeasyPrint Dependencies

1. Check Python version being used:
   ```bash
   which python3
   python3 --version
   ```

2. If using system Python, try Homebrew Python:
   ```bash
   brew install python@3.12
   /opt/homebrew/bin/python3.12 -m pip install weasyprint
   /opt/homebrew/bin/python3.12 -c "from weasyprint import HTML; print('Success!')"
   ```

3. Or create a venv with proper library paths:
   ```bash
   /opt/homebrew/bin/python3.12 -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   pytest tests/
   ```

### After WeasyPrint Works

1. Run full test suite to verify PDF generation:
   ```bash
   pytest tests/ -v
   ```

2. Implement higher-level `convert_mbox_to_pdf()` function that ties together:
   - parse_mbox or merge_and_deduplicate
   - group_emails_by_date
   - render_email_to_html for each email
   - generate_pdf for each group

3. Add continuation headers for multi-page emails (PDF post-processing)

4. Begin GUI implementation with Tkinter (5-step wizard per DESIGN.md)

### Testing Commands

```bash
# Run all tests
pytest tests/ -v

# Run specific test class
pytest tests/test_mbox_converter.py::TestPdfGeneration -v

# Run with coverage
pytest tests/ --cov=src --cov-report=html
```

</instructions>

---

## Adventure Mode Status

The project uses Adventure Mode. The adventure log is at `.ADVENTURE_MODE.md` (gitignored).

- **Level**: 3
- **Class**: Archivist
- **Title**: PDF Architect
- **XP**: 280 total

If continuing with Adventure Mode, read `.ADVENTURE_MODE.md` to restore context.

---

## Commits Made This Session

1. `dce3411` - Implement core mbox parsing, grouping, and PDF generation API
2. `78ab775` - Add comprehensive test suite with 68 tests
3. `385f6c6` - Update test fixtures for Gmail Takeout deduplication testing
4. `a989ec5` - Add project documentation and update configuration

---

## User Preferences (From CLAUDE.md)

- Follows "anti-vibe coding" - design-forward, TDD approach
- Use AskUserQuestion with structured options to reduce decision fatigue
- No emojis unless explicitly requested
- Professional objectivity - disagree when necessary
- ADHD-informed: concrete next steps, minimize friction
